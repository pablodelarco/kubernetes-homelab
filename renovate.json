{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended"
  ],
  "timezone": "Europe/Madrid",
  "semanticCommits": "enabled",
  "dependencyDashboard": true,
  "dependencyDashboardTitle": "ðŸ¤– Renovate Dashboard",
  "suppressNotifications": ["prEditedNotification"],
  "rebaseWhen": "conflicted",
  "schedule": ["after 4am and before 5am every day"],
  "pre-commit": {
    "enabled": true
  },
  "flux": {
    "fileMatch": ["cluster/.+\\.ya?ml$"]
  },
  "helm-values": {
    "fileMatch": ["apps/.+/custom-values\\.ya?ml$"]
  },
  "kubernetes": {
    "fileMatch": [
      "cluster/.+\\.ya?ml$",
      "argocd-apps/.+\\.ya?ml$",
      "apps/.+/manifests/.+\\.ya?ml$",
      "apps/media-server/.+/.+\\.ya?ml$",
      "apps/esphome/.+\\.ya?ml$",
      "apps/matter-server/.+\\.ya?ml$",
      "apps/acestream/.+\\.ya?ml$"
    ]
  },
  "regexManagers": [
    {
      "description": "Process ArgoCD Application manifests",
      "fileMatch": ["argocd-apps/.+\\.ya?ml$"],
      "matchStrings": [
        "registryUrl=(?<registryUrl>.*?)\n *chart: (?<depName>.*?)\n *targetRevision: (?<currentValue>.*)",
        "targetRevision: (?<currentValue>.*)\n.*chart: (?<depName>.*)",
        "chart: (?<depName>.*)\n.*targetRevision: (?<currentValue>.*)"
      ],
      "datasourceTemplate": "helm"
    },
    {
      "description": "Process Helm chart dependencies in Chart.yaml",
      "fileMatch": ["Chart\\.ya?ml$"],
      "matchStrings": [
        "- name: (?<depName>.*?)\n\\s+version: (?<currentValue>.*?)\n\\s+repository: (?<registryUrl>.*?)$"
      ],
      "datasourceTemplate": "helm"
    },
    {
      "description": "Process container images in values files",
      "fileMatch": ["apps/.+/custom-values\\.ya?ml$"],
      "matchStrings": [
        "repository: (?<depName>.*?)\\n.*?tag: (?<currentValue>.*)"
      ],
      "datasourceTemplate": "docker"
    }
  ],
  "packageRules": [
    {
      "description": "Auto-merge patch updates",
      "matchUpdateTypes": ["patch"],
      "automerge": true,
      "automergeType": "pr",
      "automergeStrategy": "squash"
    },
    {
      "description": "Auto-merge minor updates for stable apps (excluding Longhorn)",
      "matchUpdateTypes": ["minor"],
      "matchPackagePatterns": [
        "sealed-secrets",
        "homepage",
        "uptime-kuma",
        "home-assistant",
        "tailscale-operator"
      ],
      "automerge": true,
      "automergeType": "pr",
      "automergeStrategy": "squash"
    },
    {
      "description": "Longhorn: Require manual approval for ALL updates (phased upgrades required)",
      "matchPackageNames": ["longhorn"],
      "automerge": false,
      "separateMinorPatch": true,
      "labels": ["longhorn", "requires-manual-upgrade"],
      "prPriority": 10,
      "commitMessagePrefix": "âš ï¸ [Longhorn]",
      "prBodyNotes": [
        "âš ï¸ **IMPORTANT**: Longhorn requires phased upgrades!",
        "",
        "**Upgrade Path**: You can only upgrade one minor version at a time.",
        "- âœ… Allowed: v1.7.x â†’ v1.8.x â†’ v1.9.x â†’ v1.10.x",
        "- âŒ Not Allowed: v1.7.x â†’ v1.10.x (skipping versions)",
        "",
        "**Before merging this PR:**",
        "1. Check current Longhorn version: `helm list -n longhorn-system`",
        "2. Ensure this PR only upgrades by ONE minor version",
        "3. If multiple versions behind, merge and upgrade ONE version at a time",
        "4. Verify all volumes are healthy before next upgrade",
        "",
        "**Manual Upgrade Command:**",
        "```bash",
        "# Backup configuration first",
        "kubectl get settings -n longhorn-system -o yaml > longhorn-settings-backup.yaml",
        "",
        "# Upgrade to next minor version only",
        "helm upgrade longhorn longhorn/longhorn \\",
        "  --namespace longhorn-system \\",
        "  --version <NEXT_MINOR_VERSION> \\",
        "  --set defaultSettings.backupTarget=\"s3://k8s-backups@us-east-1/\" \\",
        "  --set defaultSettings.backupTargetCredentialSecret=\"minio-credentials\" \\",
        "  --set persistence.defaultClass=true \\",
        "  --set service.ui.type=LoadBalancer \\",
        "  --set service.ui.port=80",
        "",
        "# Verify volumes after upgrade",
        "kubectl get volumes -n longhorn-system",
        "kubectl get pods -n media",
        "```"
      ]
    },
    {
      "description": "Require manual approval for major updates",
      "matchUpdateTypes": ["major"],
      "automerge": false,
      "labels": ["major-update", "requires-review"]
    },
    {
      "description": "Group all ArgoCD app updates",
      "matchFileNames": ["argocd-apps/**"],
      "groupName": "ArgoCD Applications",
      "commitMessageTopic": "ArgoCD app {{depName}}"
    },
    {
      "description": "Separate monitoring stack updates",
      "matchPackagePatterns": [
        "kube-prometheus-stack",
        "prometheus",
        "grafana",
        "alertmanager"
      ],
      "groupName": "Monitoring Stack",
      "labels": ["monitoring"],
      "schedule": ["before 6am on monday"]
    },
    {
      "description": "Separate media stack updates",
      "matchPackagePatterns": [
        "jellyfin",
        "radarr",
        "sonarr",
        "jackett"
      ],
      "groupName": "Media Stack",
      "labels": ["media"]
    },
    {
      "description": "linuxserver/qbittorrent - use semver versioning",
      "matchPackageNames": ["linuxserver/qbittorrent"],
      "versioning": "semver",
      "labels": ["media"]
    },
    {
      "description": "Pin digest for critical infrastructure",
      "matchPackagePatterns": [
        "longhorn",
        "sealed-secrets",
        "argocd"
      ],
      "pinDigests": true
    }
  ]
}

