{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended"
  ],
  "timezone": "Europe/Madrid",
  "registryAliases": {
    "http://pajikos.github.io/home-assistant-helm-chart": "https://pajikos.github.io/home-assistant-helm-chart"
  },
  "customManagers": [
    {
      "customType": "regex",
      "description": "Process Home Assistant helm chart in ArgoCD Application",
      "fileMatch": ["argocd-apps/home-assistant\\.ya?ml$"],
      "matchStrings": [
        "repoURL: [\"']?(?<registryUrl>https?://pajikos\\.github\\.io/home-assistant-helm-chart)[\"']?\\n\\s+chart: (?<depName>home-assistant)\\n\\s+targetRevision: (?<currentValue>[0-9.]+)"
      ],
      "datasourceTemplate": "helm"
    }
  ],
  "semanticCommits": "enabled",
  "dependencyDashboard": true,
  "dependencyDashboardTitle": "ðŸ¤– Renovate Dashboard",
  "suppressNotifications": ["prEditedNotification"],
  "rebaseWhen": "conflicted",
  "schedule": ["after 4am and before 5am every day"],

  "pre-commit": {
    "enabled": true
  },
  "flux": {
    "fileMatch": ["cluster/.+\\.ya?ml$"]
  },
  "helm-values": {
    "fileMatch": ["apps/.+/custom-values\\.ya?ml$"]
  },
  "argocd": {
    "fileMatch": ["argocd-apps/.+\\.ya?ml$"]
  },
  "kubernetes": {
    "fileMatch": [
      "cluster/.+\\.ya?ml$",
      "argocd-apps/.+\\.ya?ml$"
    ]
  },
  "regexManagers": [
    {
      "description": "Process ArgoCD Application manifests (sources array format)",
      "fileMatch": ["argocd-apps/.+\\.ya?ml$"],
      "matchStrings": [
        "# renovate: registryUrl=(?<registryUrl>.*?)\\n\\s*- repoURL: .*?\\n\\s*chart: (?<depName>.*?)\\n\\s*targetRevision: (?<currentValue>.*)",
        "registryUrl=(?<registryUrl>.*?)\\n\\s*- repoURL: .*?\\n\\s*chart: (?<depName>.*?)\\n\\s*targetRevision: (?<currentValue>.*)",
        "registryUrl=(?<registryUrl>.*?)\\n *chart: (?<depName>.*?)\\n *targetRevision: (?<currentValue>.*)",
        "- repoURL: [\"']?(?<registryUrl>https?://[^\"'\\s]+)[\"']?\\n\\s*chart: (?<depName>.*?)\\n\\s*targetRevision: (?<currentValue>.*)",
        "chart: (?<depName>.*)\\n.*targetRevision: (?<currentValue>.*)"
      ],
      "datasourceTemplate": "helm"
    },
    {
      "description": "Process Helm chart dependencies in Chart.yaml",
      "fileMatch": ["Chart\\.ya?ml$"],
      "matchStrings": [
        "- name: (?<depName>.*?)\n\\s+version: (?<currentValue>.*?)\n\\s+repository: (?<registryUrl>.*?)$"
      ],
      "datasourceTemplate": "helm"
    },
    {
      "description": "Process container images in values files",
      "fileMatch": ["apps/.+/custom-values\\.ya?ml$"],
      "matchStrings": [
        "repository: (?<depName>.*?)\\n.*?tag: (?<currentValue>.*)"
      ],
      "datasourceTemplate": "docker"
    }
  ],
  "packageRules": [
    {
      "description": "Auto-merge patch updates",
      "matchUpdateTypes": ["patch"],
      "automerge": true,
      "automergeType": "pr",
      "automergeStrategy": "squash"
    },
    {
      "description": "Auto-merge minor updates for all packages (excluding Longhorn)",
      "matchUpdateTypes": ["minor"],
      "excludePackagePatterns": ["longhorn"],
      "automerge": true,
      "automergeType": "pr",
      "automergeStrategy": "squash"
    },
    {
      "description": "Longhorn: Require manual approval for ALL updates (phased upgrades required)",
      "matchPackageNames": ["longhorn"],
      "automerge": false,
      "separateMinorPatch": true,
      "labels": ["longhorn", "requires-manual-upgrade"],
      "prPriority": 10,
      "commitMessagePrefix": "âš ï¸ [Longhorn]",
      "prBodyNotes": [
        "âš ï¸ **IMPORTANT**: Longhorn requires phased upgrades!",
        "",
        "**Upgrade Path**: You can only upgrade one minor version at a time.",
        "- âœ… Allowed: v1.7.x â†’ v1.8.x â†’ v1.9.x â†’ v1.10.x",
        "- âŒ Not Allowed: v1.7.x â†’ v1.10.x (skipping versions)",
        "",
        "**Before merging this PR:**",
        "1. Check current Longhorn version: `helm list -n longhorn-system`",
        "2. Ensure this PR only upgrades by ONE minor version",
        "3. If multiple versions behind, merge and upgrade ONE version at a time",
        "4. Verify all volumes are healthy before next upgrade",
        "",
        "**Manual Upgrade Command:**",
        "```bash",
        "# Backup configuration first",
        "kubectl get settings -n longhorn-system -o yaml > longhorn-settings-backup.yaml",
        "",
        "# Upgrade to next minor version only",
        "helm upgrade longhorn longhorn/longhorn \\",
        "  --namespace longhorn-system \\",
        "  --version <NEXT_MINOR_VERSION> \\",
        "  --set defaultSettings.backupTarget=\"s3://k8s-backups@us-east-1/\" \\",
        "  --set defaultSettings.backupTargetCredentialSecret=\"minio-credentials\" \\",
        "  --set persistence.defaultClass=true \\",
        "  --set service.ui.type=LoadBalancer \\",
        "  --set service.ui.port=80",
        "",
        "# Verify volumes after upgrade",
        "kubectl get volumes -n longhorn-system",
        "kubectl get pods -n media",
        "```"
      ]
    },
    {
      "description": "Require manual approval for major updates",
      "matchUpdateTypes": ["major"],
      "automerge": false,
      "labels": ["major-update", "requires-review"]
    },
    {
      "description": "Home Assistant: Own PR, auto-merge immediately",
      "matchPackageNames": ["home-assistant"],
      "groupName": null,
      "automerge": true,
      "automergeType": "pr",
      "automergeStrategy": "squash",
      "schedule": ["at any time"],
      "labels": ["home-assistant", "auto-update"],
      "prPriority": 30
    },
    {
      "description": "Independent apps: Auto-update immediately for all versions (Helm charts only)",
      "matchPackageNames": [
        "n8n",
        "8gears.container-registry.com/library/n8n",
        "homepage"
      ],
      "automerge": true,
      "automergeType": "pr",
      "automergeStrategy": "squash",
      "schedule": ["at any time"],
      "labels": ["auto-update"],
      "prPriority": 20
    },
    {
      "description": "Critical infrastructure: Manual approval for ALL updates",
      "matchPackageNames": ["longhorn", "sealed-secrets"],
      "automerge": false,
      "labels": ["critical", "requires-review"],
      "prPriority": 10
    },

    {
      "description": "Infrastructure: Group infra tools together",
      "matchPackageNames": [
        "minio",
        "opencost",
        "argocd-image-updater",
        "renovate"
      ],
      "groupName": "Infrastructure",
      "labels": ["infrastructure"],
      "automerge": true,
      "automergeType": "pr",
      "automergeStrategy": "squash"
    },
    {
      "description": "Monitoring stack: Weekly updates",
      "matchPackagePatterns": [
        "kube-prometheus-stack",
        "prometheus",
        "grafana",
        "alertmanager"
      ],
      "groupName": "Monitoring Stack",
      "labels": ["monitoring"],
      "schedule": ["before 6am on monday"],
      "automerge": true,
      "automergeType": "pr",
      "automergeStrategy": "squash"
    },
    {
      "description": "linuxserver/qbittorrent - use semver versioning and ignore invalid v14+ versions",
      "matchPackageNames": ["linuxserver/qbittorrent"],
      "versioning": "semver",
      "allowedVersions": "<10.0.0",
      "labels": ["media"]
    },
    {
      "description": "Pin digest for critical infrastructure",
      "matchPackagePatterns": [
        "longhorn",
        "sealed-secrets",
        "argocd"
      ],
      "pinDigests": true
    }
  ]
}

