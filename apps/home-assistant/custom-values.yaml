service:
  # Service type (ClusterIP, NodePort, LoadBalancer, or ExternalName)
  type: NodePort
  # Service port
  port: 80
  # NodePort for external access (30000-32767)
  nodePort: 30400

# Persistence configuration
persistence:
  enabled: true
  accessMode: ReadWriteOnce
  size: 5Gi
  storageClass: "longhorn"  # Use Longhorn for persistent storage


ingress:
  # Enable ingress for home assistant
  enabled: true
  className: "tailscale"
  annotations:
    tailscale.com/funnel: "true"
  hosts:
    - host: home-assistant
      paths:
        - path: /
          pathType: ImplementationSpecific
  tls:
    - hosts:
      - home-assistant


# Addons configuration
addons:
  codeserver:
    enabled: true
    service:
      type: NodePort
      port: 30030


# Node affinity - Pin to worker node (going to Valencia)
affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - worker


# Environment variables
env:
  - name: TZ
    value: Europe/Madrid


# Liveness and readiness probes
livenessProbe:
  httpGet:
    path: /
    port: 8123
    scheme: HTTP
  initialDelaySeconds: 30
  periodSeconds: 10

readinessProbe:
  httpGet:
    path: /
    port: 8123
    scheme: HTTP
  initialDelaySeconds: 10
  periodSeconds: 5


# Configuration for Home Assistant
configuration:
  enabled: true
  trusted_proxies:
    - 127.0.0.0/8     # Localhost
    - 10.42.0.0/16    # K8s Pod Network
    - 10.43.0.0/16    # K8s Services Network
    - 100.64.0.0/10   # Tailscale IPv4 Range
    - fd7a:115c:a1e0::/48  # Tailscale IPv6 Range
    - 192.168.1.0/24  # Local LAN (for Matter/Thread device discovery)
  templateConfig: |-
    default_config:

    {{- if .Values.ingress.enabled }}
    http:
      use_x_forwarded_for: true
      trusted_proxies:
        {{- range .Values.configuration.trusted_proxies }}
        - {{ . }}
        {{- end }}
    {{- end}}

    # Disable login attempt notifications
    logger:
      default: info
      logs:
        homeassistant.components.http.ban: critical

    # Load frontend themes from the themes folder
    frontend:
      themes: !include_dir_merge_named themes

    # Matter/Thread/Zigbee integration
    # Requires hostNetwork: true to discover devices on local LAN
    # Home Assistant Connect ZBT-1 provides:
    #   - Thread Border Router (built-in)
    #   - Zigbee coordinator (built-in)
    #   - Matter controller capabilities
    # USB device will be auto-discovered via /dev/ttyUSB* or /dev/ttyACM*
    # Configure integrations via UI after connecting ZBT-1 to worker node

    automation: !include automations.yaml
    script: !include scripts.yaml
    scene: !include scenes.yaml


podSecurityContext:
  runAsUser: 0
  runAsGroup: 0


# Network configuration for Matter/Thread/Zigbee support
# hostNetwork: true allows Home Assistant to:
#   1. Discover devices on the local LAN (Matter/Thread)
#   2. Access USB devices directly (Home Assistant Connect ZBT-1)
#   3. Use mDNS for Matter commissioning
# This is REQUIRED for Home Assistant Connect ZBT-1 integration
hostNetwork: true

# DNS policy for hostNetwork mode
# ClusterFirstWithHostNet allows the pod to resolve k8s service DNS while using host network
dnsPolicy: ClusterFirstWithHostNet

# Security context for container
# privileged: true allows access to USB devices on the host
# Required for Home Assistant Connect ZBT-1 (Thread/Zigbee coordinator)
securityContext:
  privileged: true

