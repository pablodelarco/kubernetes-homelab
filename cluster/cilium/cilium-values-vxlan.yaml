# Cilium Helm Values for Distributed Cluster with VXLAN
# This configuration enables VXLAN overlay networking for nodes on different networks (Tailscale)

# Cluster configuration
cluster:
  name: default

# CNI configuration
cni:
  binPath: /opt/cni/bin

# IPAM configuration
ipam:
  mode: kubernetes

# IPv4 native routing CIDR (pod network)
ipv4NativeRoutingCIDR: 10.42.0.0/16

# Kubernetes API server (LAN IP)
k8sServiceHost: 192.168.1.106
k8sServicePort: 6443

# Kube-proxy replacement
kubeProxyReplacement: true

# ============================================
# TAILSCALE LOADBALANCER COMPATIBILITY
# ============================================
# Required for Tailscale operator LoadBalancer services to work.
# When Cilium runs in kube-proxy replacement mode, socket-level LB
# intercepts connections before they reach Tailscale's netfilter hooks.
# Setting hostNamespaceOnly=true bypasses socket LB in pod namespaces.
# See: https://tailscale.com/kb/1236/kubernetes-operator#cilium-in-kube-proxy-replacement-mode
socketLB:
  hostNamespaceOnly: true

# Node port configuration
nodePort:
  enabled: true

# External IPs
externalIPs:
  enabled: true

# Host services
hostServices:
  enabled: true

# Operator configuration
operator:
  replicas: 1

# Hubble (observability)
hubble:
  relay:
    enabled: true
  ui:
    enabled: true

# IP masquerading
ipMasqAgent:
  enabled: false

bpf:
  masquerade: true

# ============================================
# VXLAN OVERLAY CONFIGURATION (CRITICAL!)
# ============================================

# Routing mode: tunnel (VXLAN overlay)
# This allows nodes on different networks to communicate
routingMode: tunnel

# Tunnel protocol: VXLAN
# Encapsulates pod traffic in VXLAN tunnels between nodes
tunnelProtocol: vxlan

# Auto-direct node routes: DISABLED
# We don't assume nodes are on the same L2 network
autoDirectNodeRoutes: false

# Enable IPv4 masquerade for cross-node traffic
# This ensures proper NAT for pod traffic going through VXLAN
enableIPv4Masquerade: true

# ============================================
# NOTES:
# ============================================
# - This configuration enables distributed Kubernetes across Tailscale
# - Nodes can be on different networks (different cities, cloud providers, etc.)
# - Pod traffic is encapsulated in VXLAN tunnels (UDP port 8472)
# - All traffic goes through Tailscale's encrypted mesh network
# - To apply: helm upgrade cilium cilium/cilium -n kube-system -f cilium-values-vxlan.yaml

