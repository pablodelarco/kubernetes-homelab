name: üè† Home Assistant Deployed Notifier

on:
  push:
    branches:
      - main
    paths:
      - 'argocd-apps/home-assistant.yaml'
  workflow_dispatch: # Allow manual trigger

jobs:
  notify-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect version change

      - name: Get deployed version
        id: version
        run: |
          # Get current (new) version from the file
          NEW_VERSION=$(grep -A 2 "chart: home-assistant" argocd-apps/home-assistant.yaml | grep "targetRevision:" | awk '{print $2}')
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # Get previous version from the commit before
          git show HEAD~1:argocd-apps/home-assistant.yaml > /tmp/old-ha.yaml 2>/dev/null || echo "targetRevision: unknown" > /tmp/old-ha.yaml
          OLD_VERSION=$(grep -A 2 "chart: home-assistant" /tmp/old-ha.yaml | grep "targetRevision:" | awk '{print $2}' || echo "unknown")
          echo "old_version=$OLD_VERSION" >> $GITHUB_OUTPUT

          echo "Version change: $OLD_VERSION ‚Üí $NEW_VERSION"

      - name: Get Home Assistant app version
        id: app_version
        run: |
          # Add Helm repo and get the app version for the deployed chart
          helm repo add pajikos http://pajikos.github.io/home-assistant-helm-chart/
          helm repo update pajikos

          CHART_VERSION="${{ steps.version.outputs.new_version }}"
          APP_VERSION=$(helm search repo pajikos/home-assistant --version "$CHART_VERSION" --output json | jq -r '.[0].app_version // "unknown"')

          echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT
          echo "Home Assistant version: $APP_VERSION"

      - name: Send Telegram Notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          OLD_VERSION="${{ steps.version.outputs.old_version }}"
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          APP_VERSION="${{ steps.app_version.outputs.app_version }}"

          # Create message
          MESSAGE="üè† *Home Assistant Updated!* ‚úÖ

          üìä *Deployment Complete*
          ‚Ä¢ Helm Chart: \`${OLD_VERSION}\` ‚Üí \`${NEW_VERSION}\`
          ‚Ä¢ Home Assistant: \`${APP_VERSION}\`

          üîÑ *Status*
          ArgoCD is now deploying this version to your cluster.

          üìù *What's New?*
          [Release Notes](https://www.home-assistant.io/blog/)

          ‚úÖ *Verify*
          ‚Ä¢ Check Home Assistant is accessible
          ‚Ä¢ Test your automations"

          # Send to Telegram
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true

      - name: Log deployment
        run: |
          echo "::notice title=Home Assistant Deployed::Version ${{ steps.version.outputs.new_version }} (HA ${{ steps.app_version.outputs.app_version }}) deployed to cluster"

